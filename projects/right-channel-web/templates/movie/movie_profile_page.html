{% extends ../layout/layout.html %}
{% block content %}
  {% if params.get('movie') %}
    {% set movie = params.get('movie') %}
    <div class="row-fluid container-bordered default-margin default-padding">
      <div class="row-fluid">
        <div class="span3">
          <div class="row-fluid default-margin">
            <a>
              <img src="http://img3.douban.com/lpic/s11356673.jpg">
            </a>
          </div>
          <div class="row-fluid default-margin">
            {% include ../modules/share.html %}
          </div>
        </div>
        
        <div class="span9">
          <div class="row-fluid profile">
            <h2>
              {% from utilities import combine_titles %}
              {{ combine_titles(movie.get('title'), movie.get('original_title')) }}
              {% if movie.get('year') %}
                <small class="muted">
                  ({{ movie.get('year') }})
                </small>
              {% end %}
            </h2>
            {% if movie.get('directors') %}
              <p>
                <strong>导演:</strong> {{ ' / '.join(movie.get('directors')) }}
              </p>
            {% end %}
            {% if movie.get('casts') %}
              <p>
                <strong>主演:</strong> {{ ' / '.join(movie.get('casts')) }}
              </p>
            {% end %}
            {% if movie.get('genres') %}
              <p>
                <strong>类型:</strong> {{ ' / '.join(movie.get('genres')) }}
              </p>
            {% end %}
            {% if movie.get('countries') %}
              <p>
                <strong>地区:</strong> {{ ' / '.join(movie.get('countries')) }}
              </p>
            {% end %}
            {% if movie.get('aka') %}
              <p>
                <strong>又名:</strong> {{ ' / '.join(movie.get('aka')) }}
              </p>
            {% end %}
            {% if movie.get('douban') and 'rating' in movie.get('douban') %}
              <p>
                <strong>评分:</strong>
                <a href="{{ movie.get('douban').get('url') }}" title="豆瓣评分{{ movie.get('douban').get('rating') }}" class="douban-rating" target="_blank">
                  <i class="logo-platform-douban"></i> {{ movie.get('douban').get('rating') }}
                </a>
              </p>
            {% end %}
            {% if movie.get('summary') %}
              <p>
                <strong>简介:</strong> {{ movie.get('summary') }}
              </p>
            {% end %}
          </div>
          
          {% if movie.get('resources') and movie.get('resources').get('online') and movie.get('resources').get('online').keys() %}
            {% set playable = True %}
          {% else %}
          	{% set playable = False %}
          {% end %}
          <div class="row-fluid default-margin">
            {% if playable %}
              <div class="btn-group pull-left">
                <button class="btn btn-small btn-primary"><i class="icon-play-circle icon-white"></i> 立即观看</button>
                <button class="btn btn-small btn-primary" title="选择在线资源" data-toggle="collapse" data-target="#onlineResources"><i class="icon-plus icon-white"></i></button>
              </div>
              
              <div class="btn-group pull-left">
                <button class="btn btn-small btn-primary"><i class="icon-download-alt icon-white"></i> 立即下载</button>
                <button class="btn btn-small btn-primary dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
                <ul class="dropdown-menu">
                  {% from settings import settings %}
                  {% for provider in movie.get('resources').get('online').keys() %}
                    <li>
                      <a href="{{ movie.get('resources').get('online').get(provider).get('url') }}" title="去{{ settings['providers'][provider]['name']}}观看" target="_blank">
                        <i class="logo-platform {{ settings['providers'][provider]['logo'] }}"></i> {{ settings['providers'][provider]['name']}}
                      </a>
                    </li>
                  {% end %}
                </ul>
              </div>
            {% else %}
              <div class="badge badge-warning pull-left">
                本片暂无在线资源，点击“想看”，系统会第一时间通知您！
              </div>
            {% end %}
            
            <div class="btn-group pull-right user-interest">
              {% set user_interests = {'to_watch': '想看', 'watched': '看过', 'not_interested': '没兴趣'} %}
              <button class="btn btn-small btn-primary disabled marked-hint" style="display: {{ '' if movie.get('user_interest') else 'none' }};">已标记为{{ user_interests.get(movie.get('user_interest')) }}</button>
              <button data-movie-id="{{ movie.get('_id') }}" class="btn btn-small btn-primary marked" title="取消标记" style="display: {{ '' if movie.get('user_interest') else 'none' }};"><i class="icon-remove icon-white"></i></button>
              <button data-movie-id="{{ movie.get('_id') }}" data-interest-type="to_watch" class="btn btn-small btn-primary unmarked" title="标记为想看" style="display: {{ 'none' if movie.get('user_interest') else '' }};"><i class="icon-eye-open icon-white"></i> 想看</button>
              <button data-movie-id="{{ movie.get('_id') }}" data-interest-type="watched" class="btn btn-small btn-primary unmarked" title="标记为看过" style="display: {{ 'none' if movie.get('user_interest') else '' }};"><i class="icon-check icon-white"></i> 看过</button>
              <button data-movie-id="{{ movie.get('_id') }}" data-interest-type="not_interested" class="btn btn-small btn-primary unmarked" title="标记为没兴趣" style="display: {{ 'none' if movie.get('user_interest') else '' }};"><i class="icon-eye-close icon-white"></i> 没兴趣</button>
            </div>
            
            <div id="starRating" class="pull-right" data-movie-id="{{ movie.get('_id') }}" data-rating="{{ movie.get('user_rating') }}">
            </div>
          </div>
          
          {% if playable %}
            <div id="onlineResources" class="row-fluid default-margin collapse">
              <ul class="ul-horizontal">
                {% from settings import settings %}
                {% for provider in movie.get('resources').get('online').keys() %}
                  <li>
                    <a href="{{ movie.get('resources').get('online').get(provider).get('url') }}" title="去{{ settings['providers'][provider]['name']}}观看" target="_blank">
                      <i class="{{ settings['providers'][provider]['logo'] }}"></i> {{ settings['providers'][provider]['name']}}
                    </a>
                  </li>
                {% end %}
              </ul>
            </div>
          {% end %}
        </div>
      </div>
    </div>
    
    {% include ../modules/operation_alert.html %}
  {% end %}
{% end %}

{% block extra_links %}
  <link rel="stylesheet" type="text/css" href="{{ static_url('css/star-rating.css') }}">
{% end %}

{% block extra_scripts %}
  <script type="text/javascript" src="{{ static_url('js/jquery.cookie.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('js/utilities.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('js/rating.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('js/interest.js') }}"></script>
  <script type="text/javascript">
    $(function() {
    	/* initialize star rating */
    	$('#starRating').raty({
            half     : true,
            size     : 24,
            starHalf : '{{ static_url("img/star-half-big.png") }}',
            starOff  : '{{ static_url("img/star-off-big.png") }}',
            starOn   : '{{ static_url("img/star-on-big.png") }}',
            hints    : ['很差', '较差', '还行', '推荐', '力荐'],
            space    : false,
            score    : $('#starRating').attr('data-rating'),
            click    : function(score, evt) {
                           setRating($(this).attr('data-movie-id'), score);
                       }
        });
    	
    	/* user interest */
        $('.user-interest').on('click', '.unmarked', function() {
        	markInterest($(this));
        }).on('click', '.marked', function() {
        	unmarkInterest($(this));
        });
    });
  </script>
{% end %}